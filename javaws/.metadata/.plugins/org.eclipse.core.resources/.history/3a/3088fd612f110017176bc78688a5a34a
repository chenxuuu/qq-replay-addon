package com.sweetcreeper.qqplugin;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.Socket;
import java.net.UnknownHostException;

import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.plugin.java.JavaPlugin;

public class Qqplugin extends JavaPlugin implements Listener
{
	public String player;
	public String msg;
	
	@Override//重写父类的方法
	public void onEnable()
	{
		getLogger().info("QQGroupMessagePlugin is started successfully!");
		//注册监听
		Bukkit.getPluginManager().registerEvents(this,this);
		player="nonemessage233";
		while(player!="1")
		{
	        try
	        {
	        	Bukkit.broadcastMessage("test");
	            //1.创建客户端Socket，指定服务器地址和端口
	            Socket socket=new Socket("localhost", 2333);
	            //2.获取输出流，向服务器端发送信息
	            OutputStream os=socket.getOutputStream();//字节输出流
	            PrintWriter pw=new PrintWriter(os);//将输出流包装为打印流
	            socket.shutdownOutput();//关闭输出流
	            //3.获取输入流，并读取服务器端的响应信息
	            InputStream is=socket.getInputStream();
	            BufferedReader br=new BufferedReader(new InputStreamReader(is));
				while(player!="1")
				{
					Bukkit.broadcastMessage("test2");
		            Bukkit.broadcastMessage(br.readLine());
		            if(player!="nonemessage233")
		            {
			            pw.write("<"+player+">"+msg);
			            pw.flush();
			            player="nonemessage233";
		            }
				}
	
	            //4.关闭资源
	            br.close();
	            is.close();
	            pw.close();
	            os.close();
	            socket.close();
	        } catch (UnknownHostException e) {
	            e.printStackTrace();
	        } catch (IOException e) {
	            e.printStackTrace();
	        }
		}
	}
	@Override
	public void onDisable()
	{
		getLogger().info("QQGroupMessagePlugin is stoped successfully!");
	}
	
	@EventHandler
	public void onPlayerSay(AsyncPlayerChatEvent event)
	{
		player=event.getPlayer().getName();
		msg=event.getMessage();
		//socket(event.getPlayer().getName(), event.getMessage());
		//Bukkit.broadcastMessage("player:"+event.getPlayer().getName()+",msg:"+event.getMessage());
	}
	
}

